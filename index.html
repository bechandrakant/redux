<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goals and Todos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
  <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
</head>
<body>
  <div id="app"></div>
  <script type="text/javascript">
    // Generate Id
    function generateId() {
      return Math.ceil(Math.random() * 10000 * Math.random());
    }

    // App code
    // action types
    const ADD_TODO = "ADD_TODO";
    const REMOVE_TODO = "REMOVE_TODO";
    const TOGGLE_TODO = "TOGGLE_TODO";
    const ADD_GOAL = "ADD_GOAL";
    const REMOVE_GOAL = "REMOVE_GOAL";
    const RECEIVE_DATA = "RECEIVE_DATA";

    // action creators
    function addTodoAction (todo) {
      return {
        type: ADD_TODO, todo,
      }
    };

    function removeTodoAction (id) {
      return {
        type: REMOVE_TODO, id,
      }
    };

    function toggleTodoAction (id) {
      return {
        type: TOGGLE_TODO, id,
      }
    };

    function addGoalAction (goal) {
      return {
        type: ADD_GOAL, goal,
      }
    };

    function removeGoalAction (id) {
      return {
        type: REMOVE_GOAL, id,
      }
    };

    function receiveDataAction (todos, goals) {
      return ({
        type: RECEIVE_DATA, 
        todos,
        goals,
      })
    }

    // Reducer function
    function todos(state = [], action) {
      switch (action.type) {
        case ADD_TODO:
          return state.concat([action.todo]);
        case REMOVE_TODO:
          return state.filter((todo) => todo.id !== action.id);
        case TOGGLE_TODO:
          return state.map((todo) =>
            todo.id !== action.id
              ? todo
              : Object.assign({}, todo, { complete: !todo.complete })
          );
        case RECEIVE_DATA: 
          return action.todos;
        default:
          return state;
      }
    }

    function goals(state = [], action) {
      switch (action.type) {
        case ADD_GOAL:
          return state.concat([action.goal]);
        case REMOVE_GOAL:
          return state.filter((goal) => goal.id !== action.id);
        case RECEIVE_DATA: 
          return action.goals;
        default:
          return state;
      }
    }

    function loading(state = true, action) {
      switch(action.type) {
        case RECEIVE_DATA:
          return false;
        default:
          return state;
      }
    }

    // Middlewares
    const checker = (store) => (next) => (action) => {
      if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes("bitcoin")) {
        return alert("Nope, That\'s a bad Idea");
      }
      else if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes("bitcoin")) {
        return alert("Nope, That\'s a bad Idea");
      }
      else {
        return next(action);
      }
    }

    const logger = (store) => (next) => (action) => {
      const result = next(action);
      console.log(store.getState());
      return result;
    }

    const store = Redux.createStore(Redux.combineReducers({
      todos,
      goals,
      loading,
    }), Redux.applyMiddleware(checker, logger));

  </script>

  <script type="text/babel">

    function List (props) {
      return (
        <ul>
          {
            props && 
            props.items && 
            props.items.map(item => 
              <li key={item.id}>
                <span 
                  onClick={() => props.toggle && props.toggle(item.id)}
                  style={{ textDecoration: item.complete ? 'line-through': 'none'}}>
                  {item.name}
                </span>
                <button onClick={() => props.removeItem(item)}>X</button>
              </li>)
          }
        </ul>
      )
    }

    class Todos extends React.Component {
      state = {
        name: ""
      }

      handleClick = (e) => {
        e.preventDefault()
        return API.saveTodo(this.state.name)
                  .then((todo) => {
                    this.props.store.dispatch(addTodoAction(todo));
                    this.setState({ name: ""});
                  })
                  .catch(() => alert("An error occured, Try Again!"))
      }

      removeTodo = (todo) => {
        this.props.store.dispatch(removeTodoAction(todo.id))
        
        return API.deleteTodo(todo.id)
                  .catch(() => {
                    this.props.store.dispatch(addTodoAction(todo))
                    alert("Oops Some error Occured!")
                  })
      }

      toggleTodo = (id) => {
        this.props.store.dispatch(toggleTodoAction(id))
        
        return API.saveTodoToggle(id)
                  .catch(() => {
                    this.props.store.dispatch(toggleTodoAction(id))
                    alert("Oops Some error Occured!")
                  })
      }

      render() {
        return (
          <div>
            <h1>Todo List</h1>
            <input 
              type="text" 
              placeholder="Add Todo" 
              value={this.state.name}
              onChange={(e) => this.setState({ name: e.target.value })}
            />
            <button onClick={this.handleClick}>Add Todo</button>
            <List 
              items={this.props.todos} 
              removeItem={this.removeTodo}
              toggle={this.toggleTodo}
            />  
          </div>
        )
      }
    }

    class Goals extends React.Component {
      state = { name: "" }

      handleClick = (e) => {
        e.preventDefault()
        
        return API.saveGoal(this.state.name)
                  .then((goal) => {
                    this.props.store.dispatch(addGoalAction(goal));
                    this.setState({ name: ""});
                  })
                  .catch(() => alert("An error occured, Try Again!"))
        
      }

      removeGoal = (goal) => {
        this.props.store.dispatch(removeGoalAction(goal.id))
        return API.deleteGoal(goal.id)
                  .catch(() => {
                    this.props.dispatch(addGoalAction(goal))
                    alert("Oops Some error Occured!")
                  })
      }

      render() {
        return (
          <div>
            <h1>Goals</h1>
            <input 
              type="text"
              placeholder="Add Goal"
              value={this.state.name}
              onChange={(e) => this.setState({ name: e.target.value})}
            />
            <button onClick={this.handleClick}> Add Goal</button>
            <List 
              items={this.props.goals}
              removeItem={this.removeGoal}
            />  
          </div>
        )
      }
    }

    class App extends React.Component {

      componentDidMount() {
        const { store } = this.props
        store.subscribe(() => this.forceUpdate())
        
        Promise.all([
          API.fetchTodos(),
          API.fetchGoals(),
        ]).then(([todos, goals]) => {
          store.dispatch(receiveDataAction(todos, goals));
        })
      }
      
      render() {
        const { store } = this.props
        const { todos, goals, loading } = store.getState()
        if (loading) {
          return (<h3>Loading...</h3>);
        }
        return (
          <div>
            <Todos todos={todos} store={store}/>
            <Goals goals={goals} store={store}/>
          </div>
        )
      }
    }

    ReactDOM.render(<App store={store}/>, document.getElementById("app"))
  </script>
</body>
</html>