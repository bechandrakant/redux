<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goals and Todos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
  <script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
  <script src='https://unpkg.com/react-redux@5.0.6/dist/react-redux.min.js'></script>
</head>
<body>
  <div id="app"></div>
  <script type="text/javascript">
    // Generate Id
    function generateId() {
      return Math.ceil(Math.random() * 10000 * Math.random());
    }

    // App code
    // Reducer function

    // Middlewares
    const checker = (store) => (next) => (action) => {
      if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes("bitcoin")) {
        return alert("Nope, That\'s a bad Idea");
      }
      else if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes("bitcoin")) {
        return alert("Nope, That\'s a bad Idea");
      }
      else {
        return next(action);
      }
    }

    const logger = (store) => (next) => (action) => {
      const result = next(action);
      console.log(store.getState());
      return result;
    }

    const store = Redux.createStore(Redux.combineReducers({
      todos,
      goals,
      loading,
    }), Redux.applyMiddleware(ReduxThunk.default, checker, logger));

  </script>

  <script type="text/babel">

    function List (props) {
      return (
        <ul>
          {
            props && 
            props.items && 
            props.items.map(item => 
              <li key={item.id}>
                <span 
                  onClick={() => props.toggle && props.toggle(item.id)}
                  style={{ textDecoration: item.complete ? 'line-through': 'none'}}>
                  {item.name}
                </span>
                <button onClick={() => props.removeItem(item)}>X</button>
              </li>)
          }
        </ul>
      )
    }

    class Todos extends React.Component {
      state = {
        name: ""
      }

      addItem = (e) => {
        e.preventDefault()
        this.props.dispatch(handleAddTodo(
          this.state.name, 
          () => this.setState({ name: ""})
          )
        )
      }

      removeTodo = (todo) => {
        this.props.dispatch(handleDeleteTodo(todo))
      }

      toggleTodo = (id) => {
        this.props.dispatch(handleToggleTodo(id))
      }

      render() {
        return (
          <div>
            <h1>Todo List</h1>
            <input 
              type="text" 
              placeholder="Add Todo" 
              value={this.state.name}
              onChange={(e) => this.setState({ name: e.target.value })}
            />
            <button onClick={this.addItem}>Add Todo</button>
            <List 
              items={this.props.todos} 
              removeItem={this.removeTodo}
              toggle={this.toggleTodo}
            />  
          </div>
        )
      }
    }

    const ConnectedTodos = ReactRedux.connect((state) => ({
      todos: state.todos
    }))(Todos)

    class Goals extends React.Component {
      state = { name: "" }

      addItem = (e) => {
        e.preventDefault()
        this.props.dispatch(
          handleAddGoal(
            this.state.name, 
            () => this.setState({ name: ""})
          ));
      }

      removeGoal = (goal) => {
        this.props.dispatch(handleDeleteGoal(goal))
      }

      render() {
        return (
          <div>
            <h1>Goals</h1>
            <input 
              type="text"
              placeholder="Add Goal"
              value={this.state.name}
              onChange={(e) => this.setState({ name: e.target.value})}
            />
            <button onClick={this.addItem}> Add Goal</button>
            <List 
              items={this.props.goals}
              removeItem={this.removeGoal}
            />  
          </div>
        )
      }
    }

    const ConnectedGoals = ReactRedux.connect((state) => ({
      goals: state.goals
    }))(Goals)

    class App extends React.Component {

      componentDidMount() {
        const { dispatch } = this.props

        dispatch(handleInitialData())
      }
      
      render() {
        if (this.props.loading) {
          return (<h3>Loading...</h3>);
        }
        return (
          <div>
            <ConnectedTodos />
            <ConnectedGoals />
          </div>
        )
      }
    }

    const ConnectedApp = ReactRedux.connect((state) => ({
      loading: state.loading
    }))(App)

    ReactDOM.render(
      <ReactRedux.Provider store={store}>
        <ConnectedApp />
      </ReactRedux.Provider>,
      document.getElementById("app"))
  </script>
</body>
</html>